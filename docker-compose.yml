version: '3.8'

services:
  emby-cdn-preheat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: emby-cdn-preheat
    restart: unless-stopped
    ports:
      - "8899:8899"
    environment:
      # 服务器配置
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8899

      # 日志级别
      - LOG_LEVEL=INFO

      # 数据库配置
      - DB_FILE=data/preheat_review.db

      # 腾讯云 API 凭证（请修改为实际值）
      - TENCENT_SECRET_ID=${TENCENT_SECRET_ID:-your_secret_id_here}
      - TENCENT_SECRET_KEY=${TENCENT_SECRET_KEY:-your_secret_key_here}

      # CDN 域名
      - CDN_DOMAIN=${CDN_DOMAIN:-nginx.example.com}

      # 预热配置
      - PREHEAT_ENABLED=${PREHEAT_ENABLED:-false}
      - PREHEAT_BATCH_SIZE=${PREHEAT_BATCH_SIZE:-10}

      # Telegram Bot 审核配置
      - TELEGRAM_REVIEW_ENABLED=${TELEGRAM_REVIEW_ENABLED:-true}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_CHAT_IDS=${TELEGRAM_ADMIN_CHAT_IDS}
      - REVIEW_TIMEOUT_SECONDS=${REVIEW_TIMEOUT_SECONDS:-86400}
      - AUTO_APPROVE_IF_NO_REVIEW=${AUTO_APPROVE_IF_NO_REVIEW:-false}

      # Telegram 批量推送配置（避免触发速率限制）
      - BATCH_PUSH_INTERVAL=${BATCH_PUSH_INTERVAL:-30}
      - BATCH_PUSH_SIZE=${BATCH_PUSH_SIZE:-10}
      - MAX_ITEMS_PER_MESSAGE=${MAX_ITEMS_PER_MESSAGE:-5}

      # 智能 URL 匹配配置（用于单体 Emby 部署）
      - ENABLE_SMART_URL_MATCHING=${ENABLE_SMART_URL_MATCHING:-true}
      - SMART_MATCH_KEYWORDS=${SMART_MATCH_KEYWORDS:-剧集,电影}
      - SMART_MATCH_CDN_BASE=${SMART_MATCH_CDN_BASE:-https://your-cdn-domain.com/}

    volumes:
      # 挂载日志目录（持久化日志）
      - ./logs:/app/logs

      # 挂载数据库目录（持久化审核记录）
      - ./data:/app/data

      # 挂载媒体目录（只读，用于读取 STRM 文件）
      # 根据实际媒体路径修改
      - /media:/media:ro

    networks:
      - 1panel-network

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8899/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  1panel-network:
    external: true
